<!DOCTYPE html>
<html>
<head>
<script type="text/javascript" src="https://browserid.org/provisioning_api.js"></script>
<script type="text/javascript" src="/js/jquery.js"></script>
<script type="text/javascript">
  // begin provisioning!  This both gives us indicated to browserid that we're
  // a well formed provisioning page and gives us the parameters of the provisioning
  navigator.id.beginProvisioning(function(email, cert_duration) {
    // now we have the email address that wishes to be provisioned!
    // is he authenticated to ansonpersona.org?
    $.get('/api/whoami')
      .success(function(r) {
        email = email.replace('@ansonpersona.org, '').toLowerCase();
        if (email != r.user) {
          return navigator.id.raiseProvisioningFailure('user is not authenticated as target user');
        }

        // Awesome!  The user is authenticated as who we want to provision.  let's
        // generate a keypair
        navigator.id.genKeyPair(function(pubkey) {
          if (typeof(pubkey) == "string")
             pubkey = JSON.parse(pubkey);

          // finally, once we have a public key from the browser, we'll certify it, and
          // go pass it back
          $.ajax({
            url: '/api/cert_key',
            data: JSON.stringify({
              pubkey: pubkey,
              duration: cert_duration
            }),
            type: 'POST',
            headers: { "Content-Type": 'application/json' },
            dataType: 'json',
            success: function(r) {
              // all done!  woo!
              navigator.id.registerCertificate(r.cert);
            },
            error: function(r) {
              navigator.id.raiseProvisioningFailure("couldn't certify key");
            }
          });
        });
      })
      .error(function() {
        navigator.id.raiseProvisioningFailure('user is not authenticated');
      });
  });
</script>
</head>
</html>
